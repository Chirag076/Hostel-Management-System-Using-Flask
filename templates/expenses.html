{% extends 'base.html' %}

{% block title %}Expense Manager{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .expense-card {
        transition: all 0.3s ease;
        border-left: 4px solid #0d6efd;
    }
    
    .expense-card:hover {
        transform: translateX(5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .stats-card {
        background: linear-gradient(45deg, #0d6efd, #0b5ed7);
        color: white;
    }

    .form-card {
        background-color: #f8f9fa;
        border-radius: 15px;
    }

    .floating-label {
        position: relative;
    }

    .floating-label label {
        position: absolute;
        top: -12px;
        left: 10px;
        background: white;
        padding: 0 5px;
        font-size: 0.85rem;
        color: #0d6efd;
    }

    .filter-section {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 mb-3 text-primary">
                <i class="fas fa-wallet me-2"></i>Expense Manager
            </h1>
        </div>
    </div>

    <!-- Filter & Stats Section -->
    <div class="row mb-4">
        <!-- Month/Year Filter -->
        <div class="col-md-6 mb-3">
            <div class="card filter-section">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-filter me-2"></i>Filter Expenses
                    </h5>
                    <div class="d-flex gap-3">
                        <select class="form-select" id="monthSelect">
                            <option value="">Select Month</option>
                            {% for month in range(1, 13) %}
                            <option value="{{ month }}" {% if month == current_month %}selected{% endif %}>
                                {{ month|month_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <select class="form-select" id="yearSelect">
                            <option value="">Select Year</option>
                            {% for year in range(2020, 2025) %}
                            <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>
                                {{ year }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stats Card -->
        <div class="col-md-6 mb-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">Total Expenses</h5>
                            <small class="text-white-50">{{ current_month|month_name }} {{ current_year }}</small>
                        </div>
                        <h2 class="mb-0" id="totalExpenses">${{ "%.2f"|format(total) }}</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Section -->
    <div class="row">
        <!-- Add Expense Form -->
        <div class="col-lg-5 mb-4">
            <div class="card form-card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-plus-circle me-2"></i>Add New Expense
                    </h5>
                    <form method="POST" action="" id="expenseForm">
                        {{ form.hidden_tag() }}
                        <div class="mb-3 floating-label">
                            {{ form.item_name(class="form-control", placeholder="Enter item name") }}
                            {{ form.item_name.label(class="form-label") }}
                        </div>
                        <div class="mb-3 floating-label">
                            {{ form.price(class="form-control", placeholder="Enter price") }}
                            {{ form.price.label(class="form-label") }}
                        </div>
                        <div class="mb-3">
                            {{ form.date(class="form-control", type="date") }}
                            {{ form.date.label(class="form-label") }}
                        </div>
                        <div class="d-grid gap-2">
                            {{ form.submit(class="btn btn-primary") }}
                            <a href="{{ url_for('export_pdf', year=current_year, month=current_month) }}" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-file-pdf me-2"></i>Export PDF
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Expense List -->
        <div class="col-lg-7">
            <div class="card mt-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">
                            <i class="fas fa-table me-2"></i>Expenses List
                        </h5>
                        <button class="btn btn-success" onclick="downloadPDF()">
                            <i class="fas fa-download me-2"></i>Download PDF
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="expensesTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Item Name</th>
                                    <th>Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in expenses %}
                                <tr data-month="{{ expense.date.month }}" data-year="{{ expense.date.year }}">
                                    <td>{{ expense.date.strftime('%B %d, %Y') }}</td>
                                    <td>{{ expense.item_name }}</td>
                                    <td>${{ "%.2f"|format(expense.price) }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" onclick=editExpense"({{ expense.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick=deleteExpense"({{ expense.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    
    function filterExpenses() {
        const selectedMonth = document.getElementById('monthSelect').value;
        const selectedYear = document.getElementById('yearSelect').value;
        let total = 0;
        
        document.querySelectorAll('#expensesTable tbody tr').forEach(row => {
            const itemMonth = row.dataset.month;
            const itemYear = row.dataset.year;
            
            if ((!selectedMonth || itemMonth === selectedMonth) && 
                (!selectedYear || itemYear === selectedYear)) {
                row.style.display = '';
                const price = parseFloat(row.querySelector('td:nth-child(3)').innerText.replace('$', ''));
                total += price;
            } else {
                row.style.display = 'none';
            }
        });
        
        document.getElementById('totalExpenses').innerText = `$${total.toFixed(2)}`;
    }
    
    monthSelect.addEventListener('change', filterExpenses);
    yearSelect.addEventListener('change', filterExpenses);
});

function deleteExpense(expenseId) {
    if (confirm('Are you sure you want to delete this expense?')) {
        fetch(`/delete_expense/${expenseId}`, {
            method: 'POST',
        }).then(() => window.location.reload());
    }
}

function editExpense(expenseId) {
    // Implement edit functionality
    console.log('Edit expense:', expenseId);
}

function downloadPDF() {
    const element = document.getElementById('expensesTable');
    const opt = {
        margin: 1,
        filename: 'expenses-report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(element).save();
}
</script>
{% endblock %}